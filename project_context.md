# JellyTulli - Project Context & Architecture

**Description** : JellyTulli (Jellyfin + Tautulli) est un wrapper analytique et un traceur autonome ("Ultimate Dashboard 2.0") pour Jellyfin.

## Tech Stack
- Frontend/Backend: **Next.js 15+ (App Router, Server Components)**
- Cache en temps r√©el: **Redis (ioredis)**
- DB et ORM: **PostgreSQL + Prisma**
- Styling: **TailwindCSS + Shadcn/UI + Lucide Icons**
- DataViz: **Recharts**
- IP Localization: **geoip-country**

## Phase 3 : Tautulli Ultimate Clone Capabilities
A massive analytical refactoring was introduced focusing on Data Context and Resilience on Edge Devices (Raspberry Pi).

1. **Dashboard Tab Layout (`page.tsx`)**:
  - Encapsulated by `Tabs` (Vue d'ensemble / Analyses D√©taill√©es).
  - Heavy JS tasks partitioned within `<Suspense>` via `DeepInsights` and `GranularAnalysis`.
  
2. **Deep Insights (`DeepInsights.tsx`)**:
  - Leverages massive raw grouped data.
  - Computes `Top 5 Films`, `Top 5 Series`, `Top 5 Music`, `Top 5 Books`.
  - Determines top Playback Clients.
  - Stream Proportions visually handled via `StreamProportionsChart.tsx` (Direct vs. Transcode).

3. **Granular Analysis (`GranularAnalysis.tsx`)**:
  - 6 dedicated charts to handle grouped historical context using `StandardMetricsCharts` wrappers.
  - **Daily**: Raw Plays vs Collections ; Raw Durations vs Collections.
  - **Hourly Heatmap Equivalent**: Bar / Area grouping plays according to Hour (`00h` to `23h`).

4. **Dynamic Data Engine**:
  - Time Range Selector now contains a `React-Day-Picker` Custom scope.
  - Query endpoints and URL `searchParams` accept `?from=YYYY-MM-DD&to=YYYY-MM-DD`.

5. **Universal Security & Backups & External Migrations (`src/app/api/backup`)**:
  - Zero-Constraint JSON architecture backing up all `Users`, `Media`, `Settings`, and `Logs`.
  - Import leverages Prisma `$transaction` with a timeout of 60000ms. If one line is corrupted, the DB rolls back safely.
  - Integration of **Chunked File Migrations** from `Jellystat` (JSON) and the `Playback Reporting` plugin (CSV). The application handles these uploads via Buffers and streams to process massive imports iteratively (e.g., 500 records at a time), preventing OOM crashes on edge devices like Raspberry Pi.
  
6. **Autonomy Core (`src/server/monitor.ts`) & Docker Strategy**:
  - The heartbeat pulls from `[GlobalSettings.jellyfinUrl]/Sessions` directly from the database configuration.
  - Build pipeline relies on `output: "standalone"` making it highly effective structurally.

7. **Security & Setup (Phase 5)**:
  - Global `GlobalSettings` database configuration completely replaced `.env` variables (`JELLYFIN_URL`, `JELLYFIN_API_KEY` and `DISCORD_WEBHOOK_URL` have been strictly deleted from the codebase and Docker).
  - Implements a Setup Wizard (`/setup`) upon first boot, preventing crashes by redirecting unconfigured instances directly.
  - Jellyfin-Native Authentication via NextAuth `CredentialsProvider` calling `/Users/AuthenticateByName` enforcing `Policy.IsAdministrator`.
  - Next.js Middleware protects all analytical routes. Local `signOut` directly routes to `/login` via JS to bypass strict callbackUrl environment constraints.

8. **Elite Features (Phase 6)**:
  - **Jellyfin Native Webhooks**: `/api/webhook/jellyfin` endpoint securely traps `PlaybackStart` events for real-time Discord Alerts without polling.
  - **Yearly Heatmap**: Github-style 365-day contribution chart tracking user activity density efficiently.
  - **Newsletter Generator**: `/newsletter` standalone responsive A4-sized report aggregating the month's biggest viewers and top videos with visually immersive backdrops.
  - **Draggable Dashboard**: Utilizes a persistent `localStorage` layout state and a React wrapper `DraggableDashboard` to rearrange Server Components instantly via up/down controls in the UI.

56. 9. **Elite Features: Wrapped, Clean-up & Advanced Stats (Phase 8)**:
57.   - **JellyTulli Wrapped**: `/wrapped/[userId]` portal dynamically calculating each user's year in review (Total Watch Time, Top 3 Media, Favorite Genre, Most Active Day). Presented in a modern Instagram/Spotify Story format.
58.   - **Administrator Clean-up Assistant**: `/admin/cleanup` routing featuring a Tabular Dashboard for detecting *Ghost Media* (added >30 days ago, 0 plays) and *Abandoned Media* (started but with <80% average completion rate).
59.   - **Granular Drop-off Stats**: Detailed Analytics tab now renders average completion rates per library (Movies, Series, Music).
60.   - **Peak Concurrent Streams KPI**: Dashboard natively plots historic `PlaybackHistory` overlap using timeline events to calculate the absolute peak concurrent stream load since database origin.
61. 
66.   - **Funnel segmentation**: Deep dive inside the UX by detecting behaviors like: Zapped (<10%), Tried (10-25%), Halfway (25-80%), Finished (>80%). Coupled with dynamic PieCharts for VF/VO and SRT breakdown.
67. 
68. 11. **Large File Support & Streaming Imports (Phase 10)**:
   - **Advanced Configuration**: Next.js `bodySizeLimit` increased to `500mb` via `experimental` settings to handle mass exports.
   - **TSV Support**: Playback Reporting migration now natively handles `.tsv` and `.csv` via automatic delimiter detection in PapaParse.
   - **Memory-Efficient Streaming**: Jellystat JSON import (up to 174MB+) rewritten using `stream-json` and `stream-chain`. Records are parsed one by one from the stream and processed in chunks of 200, preventing RAM exhaustion on edge devices like Raspberry Pi.

12. **Critical Bug Fixes (Phase 11)**:
   - **Jellystat Import 174MB Fix**: Server Actions also enforce the 10MB limit on the `/settings` page path in Docker. Reverted to a **Route Handler** (`/api/backup/import/jellystat`) with the client sending the raw `File` blob via `fetch()` with `Content-Type: application/octet-stream`. The Route Handler streams `req.body` directly into `stream-json` ‚Äî zero buffering, no body parsing, no size limit. `serverExternalPackages: ['stream-json', 'stream-chain']` added to `next.config.ts` to ensure proper bundling. The Server Action file (`src/app/actions/import-jellystat.ts`) is kept as reference but no longer invoked.
   - **Playback Reporting TSV Fix**: The Playback Reporting TSV export has **no header row** ‚Äî the first line is already data. PapaParse now uses `header: false` and the mapping is done by **column index**: `[0]:Date [1]:UserId [2]:ItemId [3]:ItemType [4]:ItemName [5]:PlayMethod [6]:ClientName [7]:DeviceName [8]:PlayDuration`. Diagnostic `console.log` logs the first row sample and column count. UI text updated from "CSV" to "TSV" throughout the settings page.
   - **Unknown User Fix**: Users imported from the TSV that don't exist locally are now created with username `"Utilisateur Supprim√©"` instead of `"Unknown User"`. Their real name is resolved on the next Jellyfin sync.
   - **Logout Redirect Fix**: `signOut({ callbackUrl: '/login' })` replaced by `await signOut({ redirect: false })` followed by `window.location.href = '/login'`. This forces a pure JS redirect that always uses the current host, eliminating the `localhost:3000` redirect bug caused by NextAuth's `callbackUrl` resolution.

13. **UUID Normalization, Chunked Upload & Auto-Backups (Phase 12)**:
   - **UUID Normalization**: Playback Reporting TSV exports IDs without dashes (32 hex chars). A `normalizeUuid()` function now adds standard UUID dashes (8-4-4-4-12) before upsert, ensuring imported users correctly match existing Jellyfin users in the database.
   - **Logs CSS Overflow Fix**: Media title column in `/logs` now uses `max-w-[150px] md:max-w-[250px]` with `truncate` to prevent long titles from overflowing into adjacent columns.
   - **Chunked Upload (Jellystat 174MB)**: Client-side `File.slice()` splits the JSON into 5MB chunks sent sequentially to `/api/backup/import/jellystat/chunk`. Each chunk is saved to `/tmp/jellytulli-uploads/{uploadId}/`. A `/api/backup/import/jellystat/finalize` endpoint merges all chunks then pipes the merged file through `stream-json` for incremental DB import. Progress bar displayed in the UI (0-50% upload, 55-100% processing).
   - **Auto-Backup System**: `node-cron` task in `instrumentation.ts` triggers `performAutoBackup()` at 3:30 AM daily. The function (`src/lib/autoBackup.ts`) exports all Users, Media, PlaybackHistory and Settings to `/data/backups/jellytulli-auto-YYYY-MM-DD_HH-MM-SS.json`. Rolling rotation keeps only the 5 most recent files. A Docker named volume `jellytulli_backups` persists the backups across container rebuilds.
   - **Auto-Backup UI**: New card in `/settings` lists the 5 auto-backups with date, size, and a "Restaurer" button. Restore endpoint (`/api/backup/auto/restore`) reads the file from disk and replays it via Prisma `$transaction` with full cascade (delete ‚Üí recreate all tables).

14. **DB Pool Fix, Jellystat Parser, RBAC & Extended Wrapped (Phase 13)**:
   - **Prisma Pool Exhaustion Fix**: The singleton pattern in `src/lib/prisma.ts` now assigns `globalThis.prismaGlobal = prisma` unconditionally (not just in development). This prevents "Too many clients already" errors in production Docker. Added `log: ['error']` in production and `['warn', 'error']` in development. `DATABASE_URL` in `docker-compose.yml` now includes `&connection_limit=5` to cap Prisma's pool size on Raspberry Pi.
   - **Jellystat JSON Auto-Detection**: Jellystat exports can be either a root-level JSON array `[...]` or an object like `{"jf_playback_activity": [...]}`. Both the direct import route (`/api/backup/import/jellystat`) and the chunked finalize route (`/api/backup/import/jellystat/finalize`) now auto-detect the structure by peeking at the first bytes. If the root is an object, `pick({ filter: detectedKey })` from `stream-json/filters/Pick` is injected into the pipeline before `streamArray()`. This fixes the "0 sessions imported" bug.
   - **Logs CSS Table-Fixed**: `<Table>` in `/logs` now uses `table-fixed` class with explicit column widths (`w-[130px]` Date, `w-[120px]` User, `w-[250px]` Media, etc.). Media cell uses `overflow-hidden` + `min-w-0` flex children for proper truncation.
   - **RBAC (Admin vs User)**: Jellyfin's `Policy.IsAdministrator` is no longer gate-checked at login ‚Äî ALL Jellyfin users can now authenticate. The `isAdmin` boolean and `jellyfinUserId` are stored in the JWT via NextAuth `callbacks.jwt` and exposed on the session via `callbacks.session`. Type augmentation in `src/types/next-auth.d.ts`. The middleware (`src/middleware.ts`) checks `token.isAdmin`: admins access all routes, non-admins are restricted to `/wrapped/*` only and get redirected to `/wrapped/{jellyfinUserId}` if they try to access admin routes.
   - **Extended Wrapped Page**: The `/wrapped/[userId]` page now computes per-category breakdowns (Movies, Series, Music) with Top 3 media and total hours for each. Three new slides added to the story-style UI: "Le Grand √âcran" (Films, red gradient), "Binge Watching" (Series, sky gradient), "La Bande Son" (Music, green gradient). Each slide shows category hours + ranked Top 3 with individual watch durations. The final share card also displays the category breakdown.

15. **Duck-Typing Parser, Tooltips & NextAuth RBAC (Phase 14)**:
   - **Jellystat Duck-Typing Parser**: The `streamArray()` + `pick()` approach was fragile ‚Äî it required knowing the exact JSON structure. Replaced with `streamValues()` which emits EVERY value at any depth. A duck-typing function `isSessionObject()` checks if each value has `UserId` AND `ItemId` AND (`PlayDuration` OR `RunTimeTicks` OR `DateCreated`). Non-session values are silently skipped. Applied to both direct import (`/api/backup/import/jellystat`) and chunked finalize route. This guarantees import regardless of Jellystat's internal JSON key naming.
   - **Playback Reporting UUID Fix**: `normalizeUuid()` now lowercases the entire ID and validates it with `/^[0-9a-f]{32}$/` before inserting dashes. The variable is extracted and normalized IMMEDIATELY from `row[1]` before any Prisma call. A diagnostic log prints the before/after UUID for the first processed row.
   - **Logs Tooltip**: Added `title={log.media.title}` on the parent `<div>` wrapping the media cell in `/logs`. The native HTML `title` attribute displays the full media name on hover, complementing the CSS `truncate`.
   - **RBAC Session Fix**: `session.user.isAdmin` and `session.user.jellyfinUserId` are now exposed on `session.user` (not `session` root). Type declarations updated in `src/types/next-auth.d.ts` to extend `DefaultSession["user"]`.
   - **Dashboard Admin Guard**: `page.tsx` (Dashboard) now calls `getServerSession(authOptions)` and checks `session.user.isAdmin`. Non-admins are server-side redirected to `/wrapped/{jellyfinUserId}` via `redirect()`.
   - **API Route Protection**: Middleware now explicitly blocks non-admin access to `/api/sync`, `/api/backup`, `/api/hardware`, `/api/settings`, and `/api/admin/*` with a 403 JSON response.

16. **JSONStream Deep Scan, Ghost User Fix & Wrapped RBAC (Phase 15)**:
   - **JSONStream Deep Scan**: `stream-json` `streamValues()` emitted the entire root JSON as ONE value ‚Äî it never recursed into nested objects, causing 0 sessions imported from Jellystat. Replaced with `JSONStream.parse('..')` which recursively emits every object/value at every depth. The `isSessionObject()` duck-typing filter is preserved. Applied to both direct import (`/api/backup/import/jellystat`) and chunked finalize route. Uses event-based `data`/`end` listeners with `pause()`/`resume()` for backpressure. `JSONStream` added to `serverExternalPackages` in `next.config.ts`. No `@types/JSONStream` exists ‚Äî uses `require()` import.
   - **Ghost User Cleanup**: Playback Reporting import now runs a batch `updateMany` at the end of each import to fix all users with username `"Unknown User"` / `"Unknown"` ‚Üí `"Utilisateur Supprim√©"`. This retroactively fixes ghost users created before the Phase 11 naming fix.
   - **Wrapped Page RBAC Fix**: Sidebar (`Sidebar.tsx`) now hides on `/wrapped/*` paths (not just `/login`), giving non-admin users a clean fullscreen Wrapped experience. Middleware matcher broadened from `_next/static|_next/image` to `_next` to exclude ALL Next.js internal routes, preventing potential interference with RSC payloads and other internal fetches.

17. **JSON Case-Insensitive Parser, Local DB Fallback & User RBAC (Phase 16)**:
   - **Jellystat Case-Insensitive Duck-Typing**: Keys in Jellystat JSON exports vary wildly (`UserId`, `userId`, `user_id`). Both import routes now call `toLowerKeys(obj)` to normalize ALL keys to lowercase before testing `isSessionObject()` and before extracting field values in `processChunk()`. Condition: `lk.userid && (lk.itemid || lk.nowplayingitemid) && (lk.playduration || lk.runtimeticks)`. A diagnostic `console.log("Exemple d'objet trouv√©:", Object.keys(obj))` logs the raw keys of the first scanned object for troubleshooting. Default username in Jellystat import changed from `"Unknown User"` to `"Utilisateur Supprim√©"`.
   - **Ghost User Cleanup (All Import Routes)**: All three import routes (Jellystat direct, Jellystat finalize, Playback Reporting) now run `prisma.user.updateMany()` at completion to batch-rename users with `"Unknown User"` / `"Unknown"` ‚Üí `"Utilisateur Supprim√©"`.
   - **Local DB Username Fallback**: All display components (Logs, Users leaderboard, User detail, Dashboard top users, Wrapped) now strictly use `user.username || "Utilisateur Supprim√©"` from the local Prisma database. No external Jellyfin API calls for username resolution. This ensures deleted Jellyfin users always display a meaningful name.
   - **Middleware RBAC Restructure**: Middleware changed from a whitelist model (only `/wrapped` + `/api/auth` allowed for non-admins) to a blacklist model. New structure: `PUBLIC_USER_PATHS` = `/wrapped`, `/api/auth`, `/api/jellyfin`; `ADMIN_API_PATHS` = `/api/sync`, `/api/backup`, `/api/hardware`, `/api/settings`, `/api/admin`; `ADMIN_PAGE_PATHS` = `/`, `/logs`, `/users`, `/media`, `/newsletter`, `/admin`, `/settings`. Non-admin users can now access any route not explicitly blocked, while admin pages redirect to `/wrapped/{id}` and admin APIs return 403.
   - **Wrapped Auto-Create User**: The `/wrapped/[userId]` Server Component now auto-creates the user in Prisma if they authenticated via Jellyfin but were never synced/imported. Uses `getServerSession()` to verify the requested userId matches the logged-in user before creating. This prevents 404 errors for newly-registered non-admin users accessing their Wrapped page.

18. **Watch Party, Network Dashboard & Pro Telemetry (Phase 17)**:
   - **Watch Party Detection**: `/logs` page now runs a `detectWatchParties()` algorithm after fetching PlaybackHistory. Groups sessions of the same media (same `mediaId`) started by different users within a 5-minute window. Each detected party renders a gradient banner row in the table with `üçø Watch Party` badge showing the number of spectators and their usernames. Party member rows are visually marked with a violet left border and a `Users` icon next to the date. Custom `animate-pulse-slow` CSS animation (3s cycle) for the banner.
   - **Network Dashboard Tab**: New "R√©seau" tab added to the Dashboard page alongside "Vue d'ensemble" and "Analyses D√©taill√©es". Powered by a `NetworkAnalysis` async Server Component (`src/components/dashboard/NetworkAnalysis.tsx`) loaded via `<Suspense>`. Contains:
     - **Stats Row**: 4 KPI cards (Total Sessions, Transcode Rate %, DirectStream count, Transcoded Duration in hours).
     - **DirectPlay vs Transcode AreaChart**: `TranscodeHourlyChart` (`src/components/charts/TranscodeHourlyChart.tsx`) ‚Äî stacked area chart showing DirectPlay/DirectStream/Transcode session counts by hour of day (00h-23h). Interactive legend toggling.
     - **Client Transcode Profile**: Horizontal bar chart showing transcode % per client application.
     - **"Table des Coupables"**: Top 10 most transcoded media with resolution badge, session count, total duration, inferred cause (Subtitle Burn-in, HD Audio unsupported, 4K resolution, Client compatibility), and the primary client responsible. Causes are inferred from `subtitleCodec` (burn-in codecs: ass/ssa/pgssub/dvdsub), `audioCodec` (heavy: truehd/dts/eac3/flac), and `Media.resolution`.
   - **Pro Telemetry (Deep Insights)**: Two new donut charts added to the "Analyses D√©taill√©es" tab in `DeepInsights.tsx`:
     - **Resolution Matrix**: Joins `PlaybackHistory ‚Üí Media.resolution` to show sessions by resolution (4K, 1080p, 720p, SD, Unknown). Top 6 values displayed.
     - **Device Ecosystem**: Groups `PlaybackHistory.deviceName` to display the top 8 physical playback devices (distinct from the existing `PlatformDistributionChart` which tracks `clientName`).

19. **Import Resilience, Jellystat Relaxed Scan & Wrapped RBAC (Phase 18)**:
   - **PlaybackHistory.userId Optional**: Schema changed `userId` from `String` (required) to `String?` (optional). `user` relation changed from `User` to `User?`. `onDelete: Cascade` preserved ‚Äî deleting a User still removes their history, but orphan records (null userId) are allowed. Requires `npx prisma migrate dev` or `npx prisma db push`.
   - **Playback Reporting TSV: No Ghost Users**: `prisma.user.upsert()` replaced by `prisma.user.findUnique()`. If the UUID from TSV doesn't match any existing User, the PlaybackHistory is created with `userId: null` and `clientName` tagged with `"(Utilisateur Inconnu - TSV)"`. This prevents phantom User records from being created during import. De-duplication via `findFirst` still works with null userId.
   - **Dashboard Null Guard**: `topUsersAgg` groupBy query now includes `userId: { not: null }` filter to prevent null userId from breaking the subsequent `findUnique({ where: { id: agg.userId } })`.
   - **Jellystat Relaxed Scan**: `isSessionObject()` duck-typing in both direct import (`/api/backup/import/jellystat`) and chunked finalize route no longer requires `PlayDuration`, `RunTimeTicks`, or `DateCreated`. Simplified criterion: `hasUserId && hasItemId`. This captures sessions from Jellystat exports that omit activity duration fields. Sessions with 0 duration are imported with `durationWatched: 0`.
   - **Jellystat Detailed Logging**: Both Jellystat import routes now log: (1) keys of the first scanned object, (2) full JSON of the first matched session (truncated to 500 chars), (3) keys of up to 3 objects that have a `userId` field but were rejected (missing ItemId). This aids debugging when imports yield 0 sessions.
   - **Wrapped All-Time Fallback**: `/wrapped/[userId]` Server Component now falls back to all-time data when the current year filter yields 0 sessions. Applied to both the initial query and the auto-create re-fetch. Ensures non-admin users with only imported historical data see their Wrapped instead of an empty page.

20. **Brute-Force Imports, RBAC Fix & Media Profiler (Phase 19)**:
   - **Jellystat Brute-Force Regex**: JSONStream deep-scan parser entirely replaced. Both direct import (`/api/backup/import/jellystat`) and chunked finalize route now read the raw file as a UTF-8 string and use `RegExp.exec()` to find all `"UserId":"..."` occurrences. For each match, the enclosing `{...}` JSON object boundaries are found by scanning backward/forward for `{` and `}`. Field values (ItemId, UserName, ItemName, PlayDuration, DateCreated, PlayMethod, ClientName, DeviceName) are extracted via individual case-insensitive regex calls (`extractStr()`, `extractNum()`). Sessions without an ItemId are skipped. This approach handles 174MB single-line JSON files that crash traditional JSON parsers. `JSONStream`, `stream-json`, and `stream-chain` imports removed; `Readable` import removed from the direct route; `createReadStream` replaced by `readFileSync` in the finalize route.
   - **Middleware RBAC Overhaul**: Switched from a broad blacklist model blocking many routes for non-admins to a minimal restriction. `ADMIN_API_PATHS` reduced to `["/api/admin"]` only. `ADMIN_PAGE_PATHS` reduced to `["/admin", "/settings"]`. The `PUBLIC_USER_PATHS` concept removed entirely. Non-admin users can now access `/`, `/logs`, `/users`, `/media`, `/newsletter`, and all non-admin API routes. Pages like the Dashboard (`/`) have their own server-side `isAdmin` check and redirect.
   - **Username Display Consistency**: Newsletter page `topUser.name` fallback changed from `"Inconnu"` to `"Utilisateur Supprim√©"` for consistency with all other display components.
   - **Media Profile Page (`/media/[id]`)**: New dynamic route analyzing a specific media item. Features:
     - **Header**: Title, Poster (via Jellyfin Image proxy), genres, resolution badge, duration, production year, and community rating fetched from Jellyfin `/Items/{id}` API. Overview/synopsis displayed with `line-clamp-5`.
     - **KPI Cards**: Total watch time (hours), total views (session count), average duration per session (minutes).
     - **T√©l√©m√©trie & Drop-off**: `MediaDropoffChart` client component renders a Recharts BarChart with 10 buckets (0-10%, 10-20%, ..., 90-100%) showing session completion distribution. Color gradient from red (early drop-off) to green (completed). Based on `durationWatched / (media.durationMs / 1000)`.
     - **Historique D√©taill√©**: Full table of every playback session ‚Äî user (linked to `/users/[jellyfinUserId]`), date, play method (DirectPlay/Transcode badge), audio language + codec, subtitle language + codec, and duration watched.
   - **Media Grid Navigation**: Media cards in `/media` now wrapped in `<Link>` to `/media/{jellyfinMediaId}`, making each card clickable to its profile page.

21. **Fix StoppedAt, Soft UUID Match, Unified Backups & Media Breadcrumbs (Phase 20)**:
   - **Jellystat Import endedAt Fix**: Both direct and chunked Jellystat brute-force import routes now compute `endedAt = new Date(startedAt.getTime() + duration * 1000)` when `duration > 0`. The `endedAt` field is written to both `create` and `update` Prisma calls. This prevents imported sessions from displaying "En cours" in the logs page ‚Äî they now correctly show a calculated end time.
   - **TSV Soft UUID Matching**: The Playback Reporting TSV import route no longer does a strict `prisma.user.findUnique({ where: { jellyfinUserId } })`. Instead, all users are pre-loaded into an in-memory `Map` keyed by `jellyfinUserId.replace(/-/g, '').toLowerCase()` (dashless lowercase). The TSV row's raw UUID is also stripped of dashes and lowercased before lookup: `userMap.get(rawUserId.replace(/-/g, '').toLowerCase())`. This fixes UUID mismatches caused by casing or dash formatting differences between Playback Reporting exports and Jellyfin's stored format. `endedAt` is also computed for TSV imports using the same `startedAt + durationWatched * 1000` formula.
   - **Unified Backup Management UI**: The auto-backups card in `/settings` is now a centralized backup management section with: (1) "Sauvegarder maintenant" button triggering `/api/backup/auto/trigger` which calls `performAutoBackup()`, (2) per-backup "Supprimer" button calling `/api/backup/auto/delete` which removes the file from disk, (3) existing "Restaurer" button per backup. New API routes: `/api/backup/auto/trigger/route.ts` (POST ‚Äî calls `performAutoBackup()`), `/api/backup/auto/delete/route.ts` (POST ‚Äî `unlinkSync` with path traversal protection via `path.basename()`). The list auto-refreshes after manual trigger.
   - **Media Breadcrumb Navigation**: The `/media/[id]` page now fetches `SeriesId`, `SeriesName`, `SeasonId`, `SeasonName`, `AlbumId`, and `Album` from the Jellyfin `/Items/{id}` API response. A breadcrumb navigation bar replaces the simple "Retour" link: `Biblioth√®que > Series Name > Season Name > Current Title` for episodes, `Biblioth√®que > Album Name > Current Title` for tracks. Each breadcrumb segment links to `/media/{parentId}`, enabling hierarchical navigation through Series ‚Üí Season ‚Üí Episode or Album ‚Üí Track.

22. **Force Insert TSV, Ticks Math & X-Forwarded IP (Phase 21)**:
   - **TSV Force-Insert Users**: Playback Reporting TSV import completely reworked. The soft UUID matching (pre-loaded `userMap` with dashless lookup) is removed. For every TSV row: (1) `rawId = row[1].toLowerCase().replace(/-/g, '')`, (2) `formattedUserId = rawId.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/, '$1-$2-$3-$4-$5')`, (3) `prisma.user.upsert({ where: { jellyfinUserId: formattedUserId }, create: { jellyfinUserId: formattedUserId, username: "Utilisateur Supprim√© TSV" } })` ‚Äî always executed before history insert. The returned `user.id` is used directly for `PlaybackHistory.userId`. No more conditional null userId. Rows with invalid UUIDs (< 32 hex chars) are skipped.
   - **Jellystat Ticks Math Fix**: Duration values in Jellystat exports are in .NET ticks (1 tick = 100ns, 10,000 ticks = 1ms). Both direct and chunked import routes now extract `PlayDuration` OR `RunTimeTicks` via `extractNum()`, then compute: `durationMs = rawTicks / 10000` (ticks ‚Üí ms), `durationSeconds = Math.floor(durationMs / 1000)` for `durationWatched`, and `endedAt = new Date(startedAt.getTime() + durationMs)` when `durationMs > 0` (otherwise `endedAt = startedAt`). The old heuristic `if (duration > 10_000_000) duration /= 10_000_000` is removed.
   - **X-Forwarded-For IP Fix**: Webhook route (`/api/webhook/jellyfin`) now reads `x-forwarded-for` (first entry) and `x-real-ip` headers before falling back to the payload's `IpAddress`/`ClientIp`. A `resolveIp()` helper cleans IPv6-mapped addresses (`::ffff:`) and labels local/Docker IPs (`127.0.0.*`, `172.*`, `10.*`, `192.168.*`, `::1`) as `"R√©seau Local (Docker/LAN)"` instead of storing false IPs. The Monitor's `cleanIpAddress()` function in `src/server/monitor.ts` receives the same local IP detection: returns `"R√©seau Local (Docker/LAN)"` for all private/loopback ranges instead of `"127.0.0.1"`.

23. **Smart Upsert, Real IPs, Ticks Math Fix & Media Breadcrumbs (Phase 22)**:
   - **TSV Smart Upsert**: TSV import no longer blindly upserts every user with `"Utilisateur Supprim√© TSV"`. For each formatted UUID: `findUnique({ where: { jellyfinUserId } })` first ‚Äî if found, use the existing user (preserving their real username). Only `create` with `username: "Utilisateur Supprim√© TSV"` if the user truly doesn't exist. This preserves real usernames for already-synced Jellyfin users.
   - **TSV IP Label**: TSV exports have no IP column. All TSV-imported PlaybackHistory records now explicitly set `ipAddress: "Inconnue (TSV)"` instead of leaving it null.
   - **Jellystat IP Extraction**: Both direct and chunked Jellystat import routes now extract IP from the JSON via `extractStr(window, "IPAddress", "ip_address", "ipaddress", "RemoteEndPoint", "remote_end_point")`. The raw IP is stored directly in `PlaybackHistory.ipAddress` ‚Äî no `cleanIpAddress()` labeling applied during imports (preserving original data).
   - **Jellystat Ticks Math Correction**: Previous phase used `rawTicks / 10000` (100ns ‚Üí ms) which was wrong. Jellyfin uses 1 second = 10,000,000 ticks. Now correctly: `durationSeconds = Math.floor(rawTicks / 10_000_000)`, `endedAt = new Date(startedAt.getTime() + durationSeconds * 1000)`. Fallback: `endedAt = startedAt` when duration is 0.
   - **Jellystat Date Keys Expanded**: The `extractStr` call for dates now also searches `PlayDate`, `play_date`, `playdate`, `time_played` in addition to existing `DateCreated`/`StartedAt` variants.
   - **Media Breadcrumbs AlbumArtist**: The `/media/[id]` breadcrumb navigation now also fetches `AlbumArtist` (or first entry of `AlbumArtists[]`) from the Jellyfin API. For audio tracks, the breadcrumb reads: `Biblioth√®que > AlbumArtist > Album > Track`. AlbumArtist is displayed as plain text (not a link since it's not an item ID).

24. **Duration Fix, IP Profil, Strict Filters & Image Fallbacks (Phase 23)**:
   - **Jellystat Duration Smart Detection**: The raw value extracted by `extractNum()` for `PlayDuration`/`RunTimeTicks` may be in seconds (Jellystat) or in ticks (raw Jellyfin). Both direct and chunked import routes now apply smart detection: if `rawDuration > 10_000_000` ‚Üí assume ticks and divide by 10M; otherwise keep as-is (already seconds). `extractNum()` regex updated to match float values (`[\d.]+` instead of `\d+`) using `parseFloat` + `Math.floor`.
   - **User Profile IP & Client Columns**: The `/users/[id]/UserRecentMedia.tsx` history table now displays separate **Client**, **Appareil** (Device), and **IP** columns instead of the combined "Appareil" column. The IP address is shown in monospace font. The grouped history aggregation also tracks `ipAddress` from the latest session.
   - **Library Type Strict Filtering**: The `/media` page `buildMediaFilter()` now excludes `Audio`, `Track`, and `MusicAlbum` types from the default "Tous" tab. Music only appears when explicitly selecting the "Musique" tab. The music filter also includes `MusicAlbum` type.
   - **FallbackImage Component Upgrade**: The `FallbackImage` client component (`src/components/FallbackImage.tsx`) now wraps Next.js `<Image>` internally (instead of raw `<img>`) with full support for `fill`, `width`/`height`, and `unoptimized` props. On error or undefined `src`, renders a `<Film>` icon placeholder. All poster `<Image>` calls across 4 pages (`page.tsx`, `media/page.tsx`, `media/[id]/page.tsx`, `users/[id]/UserRecentMedia.tsx`) replaced with `<FallbackImage>`, ensuring broken Jellyfin image URLs display a graceful fallback instead of a broken image.
   - **Breadcrumbs Verified**: The `/media/[id]` breadcrumb navigation from Phase 22 confirmed working correctly with `<nav>` + `<ChevronRight>` separators and `<Link>` components for Series/Season/Album hierarchy.

25. **V2 Refonte Massive ‚Äî T√©l√©m√©trie Pro & Clean-up (Phase 25)**:
   - **Import Code Purge**: All import routes (`/api/backup/import/jellystat/` directory tree incl. chunk + finalize, `/api/backup/import/playback-reporting/route.ts`) and the server action (`src/app/actions/import-jellystat.ts`) **deleted entirely**. Settings page (`/settings/page.tsx`) fully rewritten to remove all import UI (handlers, refs, file inputs, Migrations Externes card). `next.config.ts` `serverExternalPackages` emptied (was `['stream-json', 'stream-chain', 'JSONStream']`).
   - **Enhanced Sync with CollectionType**: `src/lib/sync.ts` now fetches `/Library/VirtualFolders` and `/UserViews` to build a `parentId ‚Üí collectionType` mapping. Item types expanded to include `Audio,MusicAlbum`. Each media upsert now stores `collectionType` (string), `durationMs` (BigInt from RunTimeTicks/10000), and `parentId` (AlbumId ‚à• SeasonId ‚à• SeriesId ‚à• ParentId).
   - **Strict Library Filtering**: `/media` page `buildMediaFilter()` now uses `collectionType` field (`"movies"`, `"tvshows"`, `"music"`) instead of `type` for library tab filtering. Default "Tous" tab shows all types. Music images use `parentId` fallback for album art.
   - **Image Fallback Chain**: `getJellyfinImageUrl()` accepts optional `fallbackId` parameter. The `/api/jellyfin/image` proxy tries the primary item ID first; if it fails and `fallbackId` is provided, retries with the fallback (e.g. parent album poster for audio tracks).
   - **Prisma Schema Updates**: `Media` model gains `parentId String?`. `PlaybackHistory` model gains `pauseCount Int @default(0)`, `audioChanges Int @default(0)`, `subtitleChanges Int @default(0)`.
   - **Webhook Telemetry Overhaul**: `PlaybackStop` handler computes real duration from `PositionTicks` (ticks/10M) with wall-clock fallback. New `PlaybackProgress` handler tracks: pause state transitions via Redis keys (`pause:{id}`), audio stream index changes via Redis keys (`audio:{id}`), subtitle stream index changes via Redis keys (`sub:{id}`). Increments `pauseCount`/`audioChanges`/`subtitleChanges` on PlaybackHistory accordingly.
   - **Enhanced Media Profile Page** (`/media/[id]/page.tsx`): Full rewrite with breadcrumbs (Series‚ÜíSeason‚ÜíEpisode / Artist‚ÜíAlbum‚ÜíTrack), 6 KPI cards (total time, views, avg duration, pauses, audio changes, subtitle changes), 3-column layout (spectator list with user links, audio language distribution with progress bars, subtitle distribution with progress bars), drop-off chart, detailed history table with pause count column.
   - **Raw IP Visibility**: `cleanIpAddress()` in `src/server/monitor.ts` no longer masks local/Docker IPs as "R√©seau Local (Docker/LAN)" ‚Äî returns the raw cleaned IP. `resolveIp()` in the webhook route similarly stripped of local IP detection. Both now preserve raw IPs for full diagnostic visibility.
   - **Backup EACCES Fix**: `BACKUP_DIR` fallback changed from `"/data/backups"` to `path.join(process.cwd(), "backups")` in `src/lib/autoBackup.ts`, `/api/backup/auto/route.ts`, and `/api/backup/auto/restore/route.ts`. Prevents EACCES permission errors when running outside Docker where `/data/backups` doesn't exist.
   - **New Dashboard Charts**: Three new chart components added to the Dashboard "Vue d'ensemble" tab:
     - `MonthlyWatchTimeChart` (`src/components/charts/MonthlyWatchTimeChart.tsx`): Bar chart of watch hours per month over the last 12 months.
     - `CompletionRatioChart` (`src/components/charts/CompletionRatioChart.tsx`): Donut chart showing "Termin√©" (‚â•80%), "Partiel" (20-80%), "Abandonn√©" (<20%) session ratio based on `durationWatched / media.durationMs`. 
     - `ClientCategoryChart` (`src/components/charts/ClientCategoryChart.tsx`): Horizontal bar chart categorizing clients into TV, Web, Mobile, Desktop, Autre via `categorizeClient()` heuristic.
   - All three charts integrated as a new dashboard block row with data computed inside `getDashboardMetrics()`.

26. **Library Grouping, Heatmap Fix, Telemetry Charts & PlaybackStop Hardening (Phase 26)**:
   - **Docker Backup EACCES Fix (Obj1)**: `docker-compose.yml` now sets `BACKUP_DIR=/data/backups` environment variable. `Dockerfile` now creates `/data/backups` with `mkdir -p` and `chown nextjs:nodejs` before switching to the `nextjs` user. This ensures the backup directory exists and has correct ownership in Docker, fixing the `EACCES: permission denied, mkdir '/app/backups'` error.
   - **Library Grouping ‚Äî Series & Albums (Obj2)**: `src/app/media/page.tsx` completely reworked. The `buildMediaFilter()` now filters by `type` (not `collectionType`): "Films" tab ‚Üí `Movie`, "S√©ries" tab ‚Üí `Series`, "Musique" tab ‚Üí `MusicAlbum`, "Tous" tab ‚Üí `['Movie', 'Series', 'MusicAlbum']`. Individual Episodes, Audio tracks, and Seasons are excluded from the library grid. For Series, playback stats are aggregated via a 2-hop chain: `Season (parentId=SeriesId) ‚Üí Episode (parentId=SeasonId)` with summed plays, duration, and DirectPlay counts. For Albums, Audio tracks with `parentId=AlbumId` are aggregated directly. Each card displays `childCount` (e.g. "42 √©pisodes" / "12 pistes"). A type badge (S√©rie/Album) is overlaid on cards in the "Tous" tab.
   - **Sync Includes Season Type**: `src/lib/sync.ts` now fetches `Season` in `IncludeItemTypes` (`Movie,Series,Season,Episode,Audio,MusicAlbum`). Season items are stored with `type: "Season"` and `parentId` pointing to their parent Series. This enables the Episode‚ÜíSeason‚ÜíSeries aggregation chain used by the library grouping.
   - **Heatmap Full Year (Obj3)**: `src/components/charts/YearlyHeatmap.tsx` now imports `endOfYear` from date-fns and generates data from Jan 1 to Dec 31 (not just to today). Future dates get `count: 0, level: 0`, making all 12 month columns visible in `react-activity-calendar`.
   - **Episode‚ÜíSeries Quick Navigation (Obj4)**: `src/app/media/[id]/page.tsx` now renders prominent navigation buttons below the breadcrumb when viewing an Episode or Audio track. Buttons include "Voir la s√©rie : {seriesName}" (indigo), "Voir la saison" (violet), and "Voir l'album : {albumName}" (purple). New icons imported: `Tv`, `Music`, `Disc3` from lucide-react.
   - **Rename Labels + Telemetry Chart (Obj5)**: KPI card labels changed from "Chgts Audio" ‚Üí "Changements Audio" and "Chgts Sous-titres" ‚Üí "Changements Sous-titres". New `TelemetryChart` client component (`src/app/media/[id]/TelemetryChart.tsx`) using Recharts stacked BarChart showing pauses (yellow), audio changes (purple), and subtitle changes (cyan) per session date. Data is aggregated from `PlaybackHistory` entries grouped by `startedAt` date. The chart is displayed below the Drop-off chart when any telemetry data exists (`hasTelemetry` flag).
   - **PlaybackStop Detection Hardening (Obj6)**: (1) Webhook `PlaybackStop` handler now also deletes the `ActiveStream` record and its Redis key (`stream:{sessionId}`), preventing ghost sessions. Previously only the monitor handled ActiveStream cleanup. (2) Monitor Redis TTL increased from 30s to 60s to prevent premature key expiry during network hiccups. (3) Monitor now tracks telemetry (pause/audio/subtitle changes) for ongoing sessions via Redis state keys, matching the webhook's `PlaybackProgress` tracking ‚Äî ensures telemetry is captured even when webhook events don't fire.

27. **BigInt Fix, Resolution Matrix, Dedup, Children Navigation & Short Music Logging (Phase 27)**:
   - **BigInt Backup Serialization Fix (Obj1)**: `JSON.stringify()` crashes when Prisma returns `BigInt` values (e.g. `Media.durationMs`, `ActiveStream.positionTicks`). Both `src/lib/autoBackup.ts` and `/api/backup/export/route.ts` now use a BigInt-safe replacer: `(key, val) => typeof val === 'bigint' ? val.toString() : val`. The import routes (`/api/backup/import/route.ts` and `/api/backup/auto/restore/route.ts`) now convert `durationMs` back to `BigInt()` when restoring media records. Auto-restore also preserves all fields (collectionType, genres, resolution, parentId, telemetry counters) that were previously dropped during restore.
   - **Resolution Matrix "Inconnu 100%" Fix (Obj2)**: Two-pronged fix: (1) `src/server/monitor.ts` now extracts video resolution from the live Jellyfin session's `NowPlayingItem.MediaStreams` (video stream Width ‚Üí "4K"/"1080p"/"720p"/"SD") and writes it to the `Media.resolution` field via the existing `media.upsert()`. This fills in resolution for items that the bulk sync missed (Jellyfin sometimes omits `MediaSources` in large bulk queries). (2) `src/components/dashboard/DeepInsights.tsx` resolution chart now skips entries with `resolution: null` instead of counting them as "Inconnu". The "Inconnu" bucket only appears as a fallback when absolutely no resolution data exists.
   - **Duration Confusion & Duplicate Prevention (Obj3)**: (1) Webhook `PlaybackStop` now detects "fully watched" items: if `positionTicks >= runTimeTicks * 95%`, it uses `Math.min(ticksDuration, wallClockDuration)` to prevent logging the full media runtime when the user only rewatched part of it. (2) Monitor `PlaybackStart` block now checks for existing open PlaybackHistory (`endedAt: null`) for the same user+media before creating ‚Äî duplicates are prevented even if both webhook and monitor fire simultaneously. (3) Monitor now detects **item changes within the same Jellyfin session** (e.g. auto-play next episode): compares the current `ItemId` against the previous one stored in Redis. When the item changes, the old PlaybackHistory is closed with proper duration and a new one is created for the new item.
   - **Short Music Track Logging (Obj5)**: Webhook `PlaybackStart` handler now creates a `PlaybackHistory` entry (with dedup guard: only if no open session exists for this user+media). Previously, only the monitor created PlaybackHistory on first detection ‚Äî with 5s polling, tracks shorter than 5s could start and stop between polls and never be recorded. Now the webhook creates the entry immediately on `PlaybackStart`, and the webhook `PlaybackStop` or monitor stop handler properly closes it.
   - **Series‚ÜíSeasons‚ÜíEpisodes / Album‚ÜíTracks Navigation (Obj4)**: `src/app/media/[id]/page.tsx` now renders a full children listing table when viewing a parent item (Series, Season, or MusicAlbum). Children are queried via `prisma.media.findMany({ where: { parentId: jellyfinMediaId } })`. The table displays: index, thumbnail + title (linked to child profile), type badge, resolution badge (hidden for music), session count, and total watch time. Each child row is clickable to navigate to its own profile page. KPI stats for parent items now aggregate playback data from all children (sum of sessions + duration), giving accurate totals for Series/Album-level statistics. New icons imported: `Play`, `Film`, `ListMusic` from lucide-react.

28. **Enriched Media Names, Progress Bar, Music UX & Telemetry Charts (Phase 28)**:
   - **Enriched Hierarchical Media Names (Obj1)**: Media titles now show full context everywhere. (1) `src/server/monitor.ts` enriches the Redis payload with `SeriesName`, `SeasonName`, `AlbumName`, `AlbumArtist`, `RunTimeTicks`, `IsPaused` extracted from `session.NowPlayingItem` and `session.PlayState`. (2) Dashboard live streams (`src/app/page.tsx`): `LiveStream` type extended with `mediaSubtitle`, `progressPercent`, `isPaused`. Redis parsing builds subtitles: "SeriesName ‚Äî SeasonName" for TV episodes, "AlbumArtist ‚Äî AlbumName" for music tracks. (3) Logs page (`src/app/logs/page.tsx`): Added 2-hop parent chain lookup via `Media.parentId` ‚Üí `jellyfinMediaId`. `getMediaSubtitle()` helper returns "Series ‚Äî Season" for episodes, parent title for seasons, album for tracks. Media cell shows subtitle below the title.
   - **Live Progress Bar + Pause Indicator (Obj4)**: Live stream cards now display a progress bar beneath the media info. Purple bar when playing, yellow when paused. Percentage calculated from `PlaybackPositionTicks / RunTimeTicks * 100`, clamped 0-100%. Paused streams display a ‚è∏ emoji indicator.
   - **Music-Adaptive Media Profile (Obj2)**: `src/app/media/[id]/page.tsx` uses `isMusic = ['Audio', 'MusicAlbum'].includes(media.type)` to conditionally hide irrelevant sections for music: (1) "Changements Audio" and "Changements Sous-titres" KPI cards hidden, (2) Subtitle language distribution card hidden, (3) Subtitle column removed from detailed history table, (4) Telemetry chart zeroes out audio/subtitle bars for music (pauses only), (5) KPI grid adjusts from 3 cols (films/series) to 4 cols (music, includes Pauses card).
   - **Telemetry as Visual Charts for Films/Series (Obj3)**: For non-music media, the 3 telemetry KPI number cards (Pauses, Changements Audio, Changements Sous-titres) are replaced by a "R√©sum√© T√©l√©m√©trie" visual card with horizontal progress bars. Each bar shows the metric proportional to the max, color-coded (yellow=pauses, purple=audio, cyan=subtitles) with icons and values. The existing per-session TelemetryChart stacked BarChart is preserved below.
