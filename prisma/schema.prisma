generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(uuid())
  jellyfinUserId  String            @unique
  username        String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  playbackHistory PlaybackHistory[]
  activeStreams   ActiveStream[]
}

model Media {
  id              String            @id @default(uuid())
  jellyfinMediaId String            @unique
  title           String
  type            String            // e.g., "Movie", "Episode", "Track"
  collectionType  String?           // e.g., "movies", "tvshows"
  genres          String[]          // Tableau des genres (via sync)
  resolution      String?           // Ex: "4K", "1080p", "SD" (via sync)
  durationMs      BigInt?           // Durée totale du média
  parentId        String?           // Jellyfin ParentId (AlbumId, SeasonId, etc.) for image fallback
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  playbackHistory PlaybackHistory[]
  activeStreams   ActiveStream[]

  @@index([type])
  @@index([collectionType])
}

model PlaybackHistory {
  id              String    @id @default(uuid())
  userId          String?
  mediaId         String
  
  // Streaming Info
  playMethod      String    // e.g., "DirectPlay", "Transcode", "DirectStream"
  clientName      String?   // e.g., "Jellyfin Web", "Android TV"
  deviceName      String?   // e.g., "Chrome", "Nvidia Shield"
  
  // GeoIP / Network Info
  ipAddress       String?
  country         String?
  city            String?
  
  // Stats
  durationWatched Int       @default(0) // en secondes
  startedAt       DateTime  @default(now())
  endedAt         DateTime? // Rempli lorsque la session s'arrête
  
  // Telemetry (Audio & Subtitles)
  audioLanguage    String?   // ex: "fre", "eng"
  audioCodec       String?   // ex: "aac", "ac3"
  subtitleLanguage String?   // ex: "fre", "eng"
  subtitleCodec    String?   // ex: "subrip", "ass"
  
  // Advanced Telemetry
  pauseCount       Int       @default(0) // Number of times playback was paused
  audioChanges     Int       @default(0) // Number of audio track switches
  subtitleChanges  Int       @default(0) // Number of subtitle track switches
  
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  media           Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mediaId])
  @@index([startedAt])
  @@index([userId, startedAt])
  @@index([mediaId, startedAt])
}

model ActiveStream {
  id              String   @id @default(uuid())
  sessionId       String   @unique // Jellyfin Session ID
  userId          String
  mediaId         String
  
  // Streaming Info
  playMethod      String   // "DirectPlay", "Transcode"
  clientName      String?
  deviceName      String?
  ipAddress       String?
  country         String?
  city            String?
  
  // Transcoding Metrics
  videoCodec      String?
  audioCodec      String?
  transcodeFps    Float?
  bitrate         Int?
  
  // Telemetry (Audio & Subtitles)
  audioLanguage    String?
  subtitleLanguage String?
  subtitleCodec    String?
  
  // Tick updates
  positionTicks   BigInt?   // Position actuelle de lecture
  startedAt       DateTime @default(now())
  lastPingAt      DateTime @updatedAt // Dernière mise à jour (via webhook)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  media           Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([lastPingAt])
}

model GlobalSettings {
  id                  String   @id @default("global") // Singleton pattern pour les settings
  discordWebhookUrl   String?
  discordAlertCondition String @default("ALL") // Filtre d'envoi ('ALL', 'TRANSCODE_ONLY', 'NEW_IP_ONLY')
  discordAlertsEnabled Boolean @default(false)
  excludedLibraries   String[] @default([]) // Filtre les types de collection (ex: Photo, HomeVideos)
  updatedAt           DateTime @updatedAt
}

